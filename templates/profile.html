<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Profile - GameHub</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flashes">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <header>
        <h1>Welcome {{ session['username'] }}</h1>
        <nav>
            <a href="{{ url_for('customer') }}">Home</a> |
            <a href="{{ url_for('marketplace') }}">Marketplace</a> |
            <a href="{{ url_for('logout') }}">Logout</a>
        </nav>
    </header>

    <section class="box">
        <h2>Change Password</h2>
        <form method="post" action="{{ url_for('profile') }}">
            <label>Current Password</label>
            <input type="password" name="current_password" required>
            <label>New Password</label>
            <input type="password" name="new_password" required>
            <label>Confirm New Password</label>
            <input type="password" name="confirm_password" required>
            <button type="submit">Update Password</button>
        </form>
    </section>

    <section>
        <h2>Your Purchases</h2>
        {% if purchases %}
            <ul>
                {% for p in purchases %}
                    <li>{{ p.Game.title if p.Game }} — {{ p.purchase_date }} — {{ p.condition }} — {{ "%.2f"|format(p.price_paid) if p.price_paid is not none else "-" }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No purchases yet.</p>
        {% endif %}
    </section>

    <section>
        <h2>Your Owned Games</h2>
        {% if user_games %}
            <ul>
                {% for ug in user_games %}
                    <li>{{ ug.Game.title if ug.Game }} — Purchased {{ ug.purchase_date }} —
                        {% if ug.listed_for_sale %}
                            Listed for {{ "%.2f"|format(ug.sale_price) if ug.sale_price is not none else "-" }}
                        {% else %}
                            <a href="{{ url_for('sell', user_game_id=ug.id) }}">List for sale</a>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>You don't own any games yet.</p>
        {% endif %}
    </section>

    <section>
        <h2>Your Ratings & Reviews</h2>
        {% if ratings %}
            <ul>
                {% for r in ratings %}
                    <li>{{ r.title }} — Rating: {{ r.rating }} — {{ r.date }}<br>{{ r.review }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No ratings yet.</p>
        {% endif %}
    </section>
</body>
</html>
