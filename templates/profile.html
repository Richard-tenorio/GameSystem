<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Profile - GameHub</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .flash { margin: 10px auto; padding: 10px; border-radius: 5px; width: 80%; }
        .flash.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .flash.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <header class="header-nav">
        <div class="logo">GameHub</div>
        <div class="nav-links">
            <a href="{{ url_for('customer') }}"><i class="fas fa-gamepad icon"></i>Browse Games</a>
            <a href="{{ url_for('logout') }}" onclick="return confirm('Are you sure you want to logout?')"><i class="fas fa-sign-out-alt icon"></i>Logout</a>
        </div>
    </header>
    <main class="main-content">
        <h1>Welcome {{ session['username'] }}</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <h2>Change Password</h2>
        <form method="POST" onsubmit="return validatePassword()">
            <label for="password">New Password:</label><br>
            <input type="password" id="password" name="password" placeholder="Enter new password" required><br>
            <div id="password-error" style="color: red; display: none;"></div>
            <button type="submit">Update Password</button>
        </form>

        <h2>Purchase History</h2>
        {% if purchases %}
        <table>
            <thead>
                <tr>
                    <th>Game Title</th>
                    <th>Platform</th>
                    <th>Genre</th>
                    <th>Purchase Date</th>
                    <th>Condition</th>
                    <th>Price Paid</th>
                    <th>Seller</th>
                </tr>
            </thead>
            <tbody>
                {% for purchase in purchases %}
                <tr>
                    <td>{{ purchase.game.title }}</td>
                    <td>{{ purchase.game.platform }}</td>
                    <td>{{ purchase.game.genre }}</td>
                    <td>{{ purchase.purchase_date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ purchase.condition.title() }}</td>
                    <td>${{ "%.2f"|format(purchase.price_paid) }}</td>
                    <td>{{ purchase.seller_username or 'Store' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>You haven't purchased any games yet.</p>
        {% endif %}

        <p><a href="{{ url_for('library') }}">View My Game Library</a></p>

        <h2>My Reviews & Ratings</h2>
        {% if ratings %}
        <table>
            <thead>
                <tr>
                    <th>Game Title</th>
                    <th>Platform</th>
                    <th>Rating</th>
                    <th>Review</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for rating in ratings %}
                <tr>
                    <td>{{ rating.game.title }}</td>
                    <td>{{ rating.game.platform }}</td>
                    <td>
                        {% for i in range(5) %}
                            {% if i < rating.rating %}
                                ★
                            {% else %}
                                ☆
                            {% endif %}
                        {% endfor %}
                    </td>
                    <td>{{ rating.review or 'No review' }}</td>
                    <td>{{ rating.date.strftime('%Y-%m-%d %H:%M') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>You haven't rated any games yet.</p>
        {% endif %}

    </main>
</body>
</html>
<script>
    function validatePassword() {
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('password-error');
        const errors = [];

        if (password.length < 8) {
            errors.push('Password must be at least 8 characters long.');
        }
        if (!/[A-Z]/.test(password)) {
            errors.push('Password must contain at least one uppercase letter.');
        }
        if (!/[a-z]/.test(password)) {
            errors.push('Password must contain at least one lowercase letter.');
        }
        if (!/\d/.test(password)) {
            errors.push('Password must contain at least one digit.');
        }
        if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
            errors.push('Password must contain at least one special character (e.g., @, #, !).');
        }

        if (errors.length > 0) {
            errorDiv.innerHTML = errors.join('<br>');
            errorDiv.style.display = 'block';
            return false;
        } else {
            errorDiv.style.display = 'none';
            return true;
        }
    }
</script>
