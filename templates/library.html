{% extends "base.html" %}

{% block title %}My Library - GameSystem{% endblock %}

{% block content %}
    <div class="header-nav">
        <div class="logo">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="GameSystem Logo">
            GameSystem
        </div>
        <div class="nav-links">
            <a href="{{ url_for('customer') }}"><i class="fas fa-gamepad icon"></i>Browse Games</a>
            <a href="{{ url_for('profile') }}"><i class="fas fa-user icon"></i>Profile</a>
            <a href="{{ url_for('logout') }}" onclick="return confirm('Are you sure you want to logout?')"><i class="fas fa-sign-out-alt icon"></i>Logout</a>
        </div>
    </div>
    <main class="main-content">
        <h1>My Game Library</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if purchased_games %}
        <h2>Purchased Games</h2>
        <table>
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Game Title</th>
                    <th>Platform</th>
                    <th>Genre</th>
                    <th>Purchase Date</th>
                    <th>Condition</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for user_game in purchased_games %}
                <tr>
                    <td>
                        {% if user_game.game and user_game.game.image %}
                            <img src="{{ url_for('static', filename='uploads/' + user_game.game.image) }}" alt="GameSystem Logo" style="width: 50px; height: 50px; object-fit: cover;">
                        {% else %}
                            <img src="{{ url_for('static', filename='logo.png') }}" alt="GameSystem Logo" style="width: 50px; height: 50px; object-fit: cover;">
                        {% endif %}
                    </td>
                    <td>{{ user_game.game.title if user_game.game else user_game.title }}</td>
                    <td>{{ user_game.game.platform if user_game.game else user_game.platform }}</td>
                    <td>{{ user_game.game.genre if user_game.game else user_game.genre }}</td>
                    <td>{{ user_game.purchase_date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ user_game.condition.title() }}</td>
                    <td>
                        {% if user_game.listed_for_sale %}
                            Listed for Sale (â‚±{{ "%.2f"|format(user_game.sale_price) }})
                        {% else %}
                            Owned
                        {% endif %}
                    </td>
                    <td>
                        {% if not user_game.listed_for_sale %}
                            {% if user_game.game %}
                                <a href="{{ url_for('rate_game', game_id=user_game.game_id) }}" class="btn btn-small">Rate</a>
                                {% if user_game.game.installation_file %}
                                    <a href="/static/uploads/{{ user_game.game.installation_file }}" class="btn btn-small" download>Install</a>
                                {% endif %}
                            {% else %}
                                Owned (Community)
                            {% endif %}
                        {% else %}
                            Listed
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if created_games %}
        <h2>My Created Games</h2>
        <table>
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Game Title</th>
                    <th>Platform</th>
                    <th>Genre</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for user_game in created_games %}
                <tr>
                    <td>
                        {% if user_game.suggestion and user_game.suggestion.image %}
                            <img src="static/uploads/{{ user_game.suggestion.image }}" alt="GameSystem Logo" style="width: 50px; height: 50px; object-fit: cover;">
                        {% else %}
                            <img src="{{ url_for('static', filename='logo.png') }}" alt="GameSystem Logo" style="width: 50px; height: 50px; object-fit: cover;">
                        {% endif %}
                    </td>
                    <td>{{ user_game.title }}</td>
                    <td>{{ user_game.platform }}</td>
                    <td>{{ user_game.genre }}</td>
                    <td>
                        {% if user_game.condition == 'approved' %}
                            <span class="approved">Approved</span>
                        {% elif user_game.condition == 'suggested' %}
                            <span class="pending">Pending Approval</span>
                        {% else %}
                            {{ user_game.condition.title() }}
                        {% endif %}
                    </td>
                    <td>
                        {% if user_game.suggestion %}
                            <a href="{{ url_for('edit_user_suggestion', suggestion_id=user_game.suggestion.id) }}" class="btn btn-small">Edit</a>
                            <a href="{{ url_for('delete_suggestion', suggestion_id=user_game.suggestion.id) }}" class="btn btn-small remove-link" style="background-color: #dc3545; color: white;" onclick="return confirm('Are you sure you want to remove this suggestion?')">Remove</a>
                        {% else %}
                            No suggestion data available
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if not purchased_games and not created_games %}
        <p>You don't own any games yet.</p>
        {% endif %}

    </main>
{% endblock %}
